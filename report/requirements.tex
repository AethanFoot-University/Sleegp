\documentclass[a4paper,10pt]{article}

% Customise margin size
\usepackage[margin=1.4in]{geometry}

% Key-value storage
\usepackage{pgfkeys}

% Starred versions of commands
\usepackage{suffix}

% Long page-breaking tables
\usepackage{longtable}

% Nicer rules in tables
\usepackage{booktabs}

\usepackage{xparse}

% Multiple-column entries in tables
% \usepackage{multicolumn}

\usepackage{hyperref}

% Requirements section counter
\newcounter{reqsec}
\renewcommand{\thereqsec}{\arabic{reqsec}}

% Set a requirements section into the key-value store.
% 
% Arguments:
% 1: ID of the section
% 2: Title of the section
\DeclareDocumentCommand\setreqsec{m m}{%
  \refstepcounter{reqsec}%
  \pgfkeys{/reqsec/#1/number/.initial=\thereqsec}%
  \pgfkeys{/reqsec/#1/title/.initial=#2}%
}

% Requirements counter (resets when reqsec is incremented)
\newcounter{req}[reqsec]
\renewcommand{\thereq}{\thereqsec.\arabic{req}}

% Set a requirement into the key-value store, without displaying the requirement in a table row.
% 
% Arguments:
% 1: ID of the requirement
% 2: Body of the requirement
% 3: Priority of the requirement
% 4: This requirement's dependencies
% 5: Source of the requirement
\DeclareDocumentCommand\setreq{m m m m m}{%
  \refstepcounter{req}%
  \pgfkeys{/req/#1/number/.initial=\thereq}%
  \pgfkeys{/req/#1/body/.initial=#2}%
  \pgfkeys{/req/#1/priority/.initial=#3}%
  \pgfkeys{/req/#1/dependencies/.initial=#4}%
  \pgfkeys{/req/#1/source/.initial=#5}%  
}

% Sub-requirements counter (resets when req is incremented)
\newcounter{subreq}[req]
\renewcommand{\thesubreq}{\thereq.\arabic{subreq}}

% Set a sub-requirement into the key-value store.
% 
% Arguments:
% 1: ID of the sub-requirement
% 2: Body of the sub-requirement
% 3: Priority of the sub-requirement
% 4: This sub-requirement's dependencies
% 5: Source of the sub-requirement
\DeclareDocumentCommand\setsubreq{m m m m m}{%
  \refstepcounter{subreq}%
  \pgfkeys{/subreq/#1/number/.initial=\thesubreq}%
  \pgfkeys{/subreq/#1/body/.initial=#2}%
  \pgfkeys{/subreq/#1/priority/.initial=#3}%
  \pgfkeys{/subreq/#1/dependencies/.initial=#4}%
  \pgfkeys{/subreq/#1/source/.initial=#5}%  
}

\makeatletter
\newcommand{\manuallabel}[2]{\def\@currentlabel{#2}\label{#1}}
\makeatother

\newenvironment{reqsection}{%
  % Command definitions

  % Display the section identified by the given ID as a table row.
  %
  % Arguments:
  % 1: ID of the section.
  \DeclareExpandableDocumentCommand\reqsec{s m}{%
    \toprule
    \multicolumn{3}{l}{%
      \textbf{\pgfkeysvalueof{/reqsec/##2/number}%
        % Insert a label if there was no star on the command
        \IfBooleanTF{##1}{}{\manuallabel{reqsec:##2}{\pgfkeysvalueof{/reqsec/##2/number}}}%
        : \pgfkeysvalueof{/reqsec/##2/title}}} \\
    \midrule
  }%

  % Display the requirement identified by the given ID as a table row.
  \DeclareExpandableDocumentCommand\req{s m}{%
    \pgfkeysvalueof{/req/##2/number}%
    % Insert a label if there was no star on the command
    \IfBooleanTF{##1}{}{\manuallabel{req:##2}{\pgfkeysvalueof{/req/##2/number}}} &
    \pgfkeysvalueof{/req/##2/body} &
    \emph{Priority:} \pgfkeysvalueof{/req/##2/priority} \newline
    \emph{Dependencies:} \pgfkeysvalueof{/req/##2/dependencies} \newline
    \emph{Source:} \pgfkeysvalueof{/req/##2/source} \\
  }

  % Display the sub-requirement identified by the given ID as a table row.
  \DeclareExpandableDocumentCommand\subreq{s m}{%
    \pgfkeysvalueof{/subreq/##2/number}%
    % Insert a label if there was no star on the command
    \IfBooleanTF{##1}{}{\manuallabel{subreq:##2}{\pgfkeysvalueof{/subreq/##2/number}}} &
    \pgfkeysvalueof{/subreq/##2/body} &
    \emph{Priority:} \pgfkeysvalueof{/subreq/##2/priority} \newline
    \emph{Dependencies:} \pgfkeysvalueof{/subreq/##2/dependencies} \newline
    \emph{Source:} \pgfkeysvalueof{/subreq/##2/source} \\
  }
  
  % Header
  \begin{longtable}{p{.07\textwidth} p{.43\textwidth} p{.40\textwidth}}
}{% Footer
  \bottomrule
  \end{longtable}
}

\begin{document}

\section{Requirements}

\setreqsec{testsec}{Test requirement section}
\setreq{testreq}{Test req}{Test priority}{Test deps}{Test src}
\setreq{testreq2}{Test req2}{Test priority}{\ref{req:testreq}}{Test src}
\setreq{testreq3}{Test req3}{Test priority}{Test deps}{Test src}

\begin{reqsection}
  \reqsec{testsec}
  \req{testreq}
  \req{testreq2}
  \req{testreq3}
\end{reqsection}

\end{document}
